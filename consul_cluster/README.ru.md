# consul_cluster

Роль предназначена для установки кластера **consul** и конфигурирования его ACL системы.

Все используемые переменные и их описания указаны в файле defaults/main.yml.

Роль делает следующее:
- Проверяет размер указанного кластера в переменной `consul_cluster_nodes`: на данный момент
  поддерживаются только кластера с размером 3 или 5 нод;
- Устанавливает и конфигурирует `consul` агенты в режиме сервера на указанные ноды;
- Создаёт/обновляет/удаляет токены и прикрепленные к ним правила;
- При необходимости запускает `traefik` прокси для более удобного доступа к веб-интерфейсу консула;

`Traefik` прокси здесь нужен только для удобства оператора, будет роль его ставить или нет
зависит от значения параметра `consul_cluster_use_traefik_for_ui`. `Traefik` с помощью docker-меток
настраивается таким образом, что во все запросы добавляется специальный `HTTP`-заголовок `X-Consul-Token`
с токеном, который добавляется в `consul`-кластер с минимальными правами - только для чтения нод и сервисов.
Тем самым у оператора отпадает необходимость вводить каждый раз токен при работе с `consul` веб-интерфейсом.
`Traefik` будет доступен на 80 порту. При остановке или недоступности `consul`-агента `Traefik` будет отдавать
`502`-ошибку.

### Резервное копирование

Резервное копирование настраивается с помощью двух параметров:
* `consul_cluster_backup_timer_spec` - спецификация (в формате systemd.time) частоты запуска резервного копирования;
* `consul_cluster_backups_keep_count` - количество хранимых копий;

Фактически эти переменные просто пробрасываются в зависимую **consul_agent** роль.

### Работа с токенами

К имени каждого токена добавляется суффикс с наименованием кластера, если токен локальный или 'global', если - глобальный.
Например: `token1-dc1` (локальный, созданный для кластера с именем `dc1`) и `token2-global` (глобальный).

Правила (policy) же для токенов создаются с суффиксом `-policy` (например: `token1-dc1-policy`, `token2-global-policy`).

!!! На данный момент роль не поддерживает создание токенов
    с [service identities](https://developer.hashicorp.com/consul/docs/security/acl#service-identities)
    и [nodes identities](https://developer.hashicorp.com/consul/docs/security/acl#node-identities).

При создании кластера создается супер-токен с полными правами, сам токен задается в переменной `consul_cluster_super_token`.

Далее с его помощью создаются/обновляются пользовательские токены, который указаны в `consul_cluster_tokens` переменной:

Рассмотрим пример:
```yaml
consul_cluster_tokens:
  token-2-id:
    token: 99d4610c-e993-4395-bf45-232184802b35
    expirationttl: 10m
    rules:
      service_prefix "" { policy = "read" }
      key_prefix "" { policy = "read" }
      node_prefix "" { policy = "read" }
```

Из примера видим, что будет создан токен с указанным `uuid`.
Для удобства оператора в комментарии к этому токену будет указано:`Token 'token-2-id-global'`.
Как видим, токен будет временным (указан параметр `expirationttl`) и глобальным (реплицироваться на все датацентры).
К токену будет прикреплена политика с именем `token-2-id-global-policy` и правилами указанными в поле `rules`.

С форматом правил можно ознакомиться [здесь](https://developer.hashicorp.com/consul/docs/security/acl/acl-policies#policy-format).

Токены у которых был изменен `local` параметр, будут пересозданы (т.е. сначала удалены, потом созданы),
т.к. `consul` не поддерживает изменение этого параметра на лету.

Помимо пользовательских токенов, а также супер-токена будут созданы ещё 2 дополнительных вспомогательных токена:
* `cluster-agent-dc1` - для доступа самих серверных агентов к `consul`-каталогу;
* `traefik-dc1` - для доступа к веб-интерфейсу `consul` через `traefik`-прокси;

Оба примера указаны для кластера с настройкой `consul_cluster_datacenter: dc1`.

С правилами вспомогательных токенов можно ознакомиться в `vars/main.yml` файле.

### Работа с несколькими дата-центрами

Роль поддерживает запуск и настройку нескольких `consul`-кластеров в разных датацентрах.
Например, мы хотим запустить 2 кластера с наименованиями `dc1` и `dc2`, нам нужно определить эти хосты так:
```ini
[consul_cluster:children]
consul_cluster_dc1
consul_cluster_dc2

[consul_cluster_dc1:vars]
consul_cluster_datacenter=dc1
consul_cluster_wan_nodes="{{ groups['consul_cluster_dc2'] }}"

[consul_cluster_dc1]
consul-1
consul-2
consul-3

[consul_cluster_dc2:vars]
consul_cluster_datacenter=dc2
consul_cluster_wan_nodes="{{ groups['consul_cluster_dc1'] }}"

[consul_cluster_dc2]
consul-4
consul-5
consul-6
```

Playbook будет выглядеть следующим образом:
```yaml
---
- name: Create consul cluster in 'dc1' datacenter
  hosts: consul_cluster_dc1
  roles:
    - consul_cluster

- name: Create consul cluster in 'dc2' datacenter
  hosts: consul_cluster_dc2
  roles:
    - consul_cluster
```

И помимо остальных переменных необходимо будет объявить следующие:
```yaml
consul_cluster_replication_token: ...
consul_cluster_primary_datacenter: dc1
```

Токен репликации создается на главном кластере и прописывается в конфигурационные файлы второстепенных кластеров.

Остальные токены конфигурируются (создаются/обновляются/удаляются) следующим образом:
* глобальные - только на главном кластера;
* локальные - на каждом кластере отдельно;
